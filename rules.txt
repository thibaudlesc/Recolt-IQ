rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonctions d'aide ---
    function isOwner(userId) {
      // Vérifie si l'utilisateur authentifié est le propriétaire du document.
      return request.auth.uid == userId;
    }

    function isSharedUser() {
      // Vérifie si l'UID de l'utilisateur se trouve dans le tableau 'accessControl' du document.
      // 'resource' représente le document tel qu'il existe AVANT la modification.
      return resource.data.accessControl.hasAny([request.auth.uid]);
    }

    // --- Profils Utilisateurs ---
    match /users/{userId} {
      // N'importe qui d'authentifié peut lire les profils (pour afficher les noms, par exemple).
      allow read: if request.auth != null;
      // Seul le propriétaire peut modifier son propre profil.
      allow write: if isOwner(userId);
    }

    // --- Noms des Bennes (spécifique à chaque utilisateur) ---
    match /users/{userId}/trailerNames/{trailerNameId} {
       // Seul le propriétaire peut gérer sa liste de bennes.
       allow read, write: if isOwner(userId);
    }

    // --- Jetons de Partage (temporaires) ---
    match /shareTokens/{tokenId} {
      // N'importe qui d'authentifié peut créer, lire ou supprimer un jeton.
      // La sécurité réside dans le fait que les jetons sont uniques et supprimés après usage.
      allow read, create, delete: if request.auth != null;
    }

    // --- Parcelles (la règle la plus importante) ---
    match /users/{ownerId}/fields/{fieldId} {

      // CRÉER une parcelle :
      // Seul le propriétaire peut créer une parcelle dans sa propre collection.
      allow create: if isOwner(ownerId);

      // LIRE une parcelle :
      // Le propriétaire ET les utilisateurs invités (dans accessControl) peuvent lire les données.
      allow read: if isOwner(ownerId) || isSharedUser();

      // METTRE À JOUR une parcelle :
      allow update: if
        // Règle 1: Le propriétaire peut tout modifier.
        isOwner(ownerId) ||

        // Règle 2: Un utilisateur invité peut UNIQUEMENT modifier la liste des bennes ('trailers').
        // Tous les autres champs de la parcelle (nom, culture, etc.) doivent rester identiques.
        (
          isSharedUser() &&
          request.resource.data.name == resource.data.name &&
          request.resource.data.crop == resource.data.crop &&
          request.resource.data.size == resource.data.size &&
          request.resource.data.ownerId == resource.data.ownerId &&
          request.resource.data.accessControl == resource.data.accessControl
        ) ||

        // Règle 3: Un nouvel utilisateur accepte une invitation.
        // C'est une mise à jour où seul le tableau 'accessControl' est modifié pour y ajouter le nouvel UID.
        (
          request.resource.data.accessControl == resource.data.accessControl.union([request.auth.uid]) &&
          request.resource.data.name == resource.data.name &&
          request.resource.data.crop == resource.data.crop &&
          request.resource.data.size == resource.data.size &&
          request.resource.data.ownerId == resource.data.ownerId &&
          request.resource.data.trailers == resource.data.trailers
        );

      // SUPPRIMER une parcelle :
      // Seul le propriétaire peut supprimer sa propre parcelle.
      allow delete: if isOwner(ownerId);
    }
  }
}
